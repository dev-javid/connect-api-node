{"version":3,"sources":["../../src/middlewares/auth.middleware.ts"],"sourcesContent":["import { NextFunction, Response } from 'express';\nimport { verify } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, RequestWithUser } from '@interfaces/auth.interface';\nimport userModel from '@models/users.model';\nimport { roleRights } from '@/config/roles';\nimport { User } from '@/interfaces/users.interface';\n\nconst authMiddleware =\n  (...requiredRights: string[]) =>\n  async (req: RequestWithUser, res: Response, next: NextFunction) => {\n    try {\n      const Authorization = req.cookies['Authorization'] || (req.header('Authorization') ? req.header('Authorization').split('Bearer ')[1] : null);\n\n      if (Authorization) {\n        const secretKey: string = SECRET_KEY;\n        const verificationResponse = (await verify(Authorization, secretKey)) as DataStoredInToken;\n        const userId = verificationResponse._id;\n        const findUser = await userModel.findById(userId);\n\n        if (findUser) {\n          if (authorized(requiredRights, findUser, req)) {\n            req.user = findUser;\n            next();\n          } else {\n            next(new HttpException(401, 'Unauthorized user'));\n          }\n        } else {\n          next(new HttpException(401, 'Wrong authentication token'));\n        }\n      } else {\n        next(new HttpException(404, 'Authentication token missing'));\n      }\n    } catch (error) {\n      next(new HttpException(401, 'Wrong authentication token'));\n    }\n  };\n\n// const authMiddleware = async (req: RequestWithUser, res: Response, next: NextFunction) => {\n//   try {\n//     const Authorization = req.cookies['Authorization'] || (req.header('Authorization') ? req.header('Authorization').split('Bearer ')[1] : null);\n\n//     if (Authorization) {\n//       const secretKey: string = SECRET_KEY;\n//       const verificationResponse = (await verify(Authorization, secretKey)) as DataStoredInToken;\n//       const userId = verificationResponse._id;\n//       const findUser = await userModel.findById(userId);\n\n//       if (findUser) {\n//         req.user = findUser;\n//         next();\n//       } else {\n//         next(new HttpException(401, 'Wrong authentication token'));\n//       }\n//     } else {\n//       next(new HttpException(404, 'Authentication token missing'));\n//     }\n//   } catch (error) {\n//     next(new HttpException(401, 'Wrong authentication token'));\n//   }\n// };\n\nexport default authMiddleware;\nfunction authorized(requiredRights: string[], findUser: User, req: RequestWithUser) {\n  if (requiredRights.length) {\n    const userRights = roleRights.get(findUser.role);\n    if (!userRights) {\n      return false;\n    }\n    const hasRequiredRights = requiredRights.every((requiredRight: string) => userRights.includes(requiredRight));\n    if (!hasRequiredRights && req.params['userId'] !== findUser._id) {\n      return false;\n    }\n  }\n}\n"],"names":["authMiddleware","requiredRights","req","res","next","Authorization","cookies","header","split","secretKey","SECRET_KEY","verificationResponse","verify","userId","_id","findUser","userModel","findById","authorized","user","HttpException","error","length","userRights","roleRights","get","role","hasRequiredRights","every","requiredRight","includes","params"],"mappings":";;;;+BA+DA;;aAAA;;8BA9DuB;wBACI;+BACG;mDAER;uBACK;;;;;;AAG3B,MAAMA,iBACJ,CAAC,GAAGC,iBACJ,OAAOC,KAAsBC,KAAeC,OAAuB;QACjE,IAAI;YACF,MAAMC,gBAAgBH,IAAII,OAAO,CAAC,gBAAgB,IAAKJ,CAAAA,IAAIK,MAAM,CAAC,mBAAmBL,IAAIK,MAAM,CAAC,iBAAiBC,KAAK,CAAC,UAAU,CAAC,EAAE,GAAG,IAAI,AAAD;YAE1I,IAAIH,eAAe;gBACjB,MAAMI,YAAoBC,kBAAU;gBACpC,MAAMC,uBAAwB,MAAMC,IAAAA,oBAAM,EAACP,eAAeI;gBAC1D,MAAMI,SAASF,qBAAqBG,GAAG;gBACvC,MAAMC,WAAW,MAAMC,mBAAS,CAACC,QAAQ,CAACJ;gBAE1C,IAAIE,UAAU;oBACZ,IAAIG,WAAWjB,gBAAgBc,UAAUb,MAAM;wBAC7CA,IAAIiB,IAAI,GAAGJ;wBACXX;oBACF,OAAO;wBACLA,KAAK,IAAIgB,4BAAa,CAAC,KAAK;oBAC9B,CAAC;gBACH,OAAO;oBACLhB,KAAK,IAAIgB,4BAAa,CAAC,KAAK;gBAC9B,CAAC;YACH,OAAO;gBACLhB,KAAK,IAAIgB,4BAAa,CAAC,KAAK;YAC9B,CAAC;QACH,EAAE,OAAOC,OAAO;YACdjB,KAAK,IAAIgB,4BAAa,CAAC,KAAK;QAC9B;IACF;MA0BF,WAAepB;AACf,SAASkB,WAAWjB,cAAwB,EAAEc,QAAc,EAAEb,GAAoB,EAAE;IAClF,IAAID,eAAeqB,MAAM,EAAE;QACzB,MAAMC,aAAaC,iBAAU,CAACC,GAAG,CAACV,SAASW,IAAI;QAC/C,IAAI,CAACH,YAAY;YACf,OAAO,KAAK;QACd,CAAC;QACD,MAAMI,oBAAoB1B,eAAe2B,KAAK,CAAC,CAACC,gBAA0BN,WAAWO,QAAQ,CAACD;QAC9F,IAAI,CAACF,qBAAqBzB,IAAI6B,MAAM,CAAC,SAAS,KAAKhB,SAASD,GAAG,EAAE;YAC/D,OAAO,KAAK;QACd,CAAC;IACH,CAAC;AACH"}